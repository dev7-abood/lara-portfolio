# nixpacks.toml - Nixpacks configuration for Laravel 11

[phases.setup]
# Add PHP repository, then install Composer
cmds = [
    "apt-get update && apt-get install -y lsb-release apt-transport-https ca-certificates curl",
    "curl -fsSL https://packages.sury.org/php/apt.gpg | apt-key add -",
    "echo 'deb https://packages.sury.org/php/ $(lsb_release -sc) main' > /etc/apt/sources.list.d/php.list",
    "apt-get update",
    "curl -sS https://getcomposer.org/installer | php",
    "mv composer.phar /usr/local/bin/composer"
]

aptPkgs = [
    "git",
    "unzip",
    "curl",
    "libpng-dev",
    "libjpeg-dev",
    "libfreetype6-dev",
    "php8.2",
    "php8.2-cli",
    "php8.2-mbstring",
    "php8.2-xml",
    "php8.2-bcmath",
    "php8.2-curl",
    "php8.2-tokenizer",
    "php8.2-zip",
    "php8.2-fpm",
    "php8.2-mysql",
    "php8.2-gd",
    "nodejs",
    "npm"
]

cmds = [
    "curl -sS https://getcomposer.org/installer | php",
    "mv composer.phar /usr/local/bin/composer"
]

[phases.build]
# Run all Laravel build commands inside the app directory
cmds = [
    "composer install --no-dev --prefer-dist --optimize-autoloader",
    "php artisan config:cache",
    "php artisan route:cache",
    "php artisan view:cache",
    "php artisan storage:link"
]

[phases.start]
# Start Laravel inside the app directory
cmds = ["php artisan serve --host=0.0.0.0 --port=${PORT}"]

[plan]
# Define runtime environment
runtime = "php"

# Install required PHP extensions for Laravel 11
packages = [
    "php",
    "php-cli",
    "php-mbstring",
    "php-xml",
    "php-bcmath",
    "php-curl",
    "php-tokenizer",
    "php-zip",
    "php-fpm",
    "php-pdo",
    "php-mysql",
    "php-opcache",
    "php-gd"
]

# Include essential Laravel directories and files
include = [".env", "storage", "bootstrap/cache", "public"]
